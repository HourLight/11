<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>馥靈之鑰 Hour Light｜芳香能量調頻線上抽牌</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
/* ……原本 CSS 全留…… */
body{/*...*/}
h1{/*...*/}
button{/*...*/}
.card-container{/*...*/}
/* ★★ 新增：解牌結果區塊樣式 ★★ */
#answer{
  white-space:pre-wrap;background:rgba(255,255,255,.9);
  border:1px solid #bbb;padding:15px;margin:25px auto;
  max-width:800px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1);
  font-size:18px;line-height:1.6;color:#333;display:none;
}
</style>
</head>
<body>

<!-- 省略前面說明與按鈕的 HTML，不變 -->

<div id="result"></div>

<!-- ★★ 新增：直接解析按鈕 ★★ -->
<button id="interpretBtn" style="background:#6b4f3e;">🌿 直接解析（不跳轉）</button>

<button id="copyBtn" onclick="copyResult()">📋 複製牌卡編號</button>

<!-- ……原本 Step 3 說明區、預約區、返回首頁按鈕…… -->

<!-- ★★ 新增：顯示 GPT 解牌文字 ★★ -->
<div id="answer"></div>

<script>
let selectedCards = [];

/* 你的現有函式：格式化＋抽牌＋複製，都保留 */
function formatCardNumber(card){
  return card<=22?'A'+(card-1).toString().padStart(2,'0'):(card-22).toString().padStart(3,'0');
}
function drawCards(num){
  alert("請閉上眼睛，深呼吸，專心想著您的問題，再點擊確認。(關閉按下後即抽牌");
  selectedCards=[];
  while(selectedCards.length<num){
    let n=Math.floor(Math.random()*130)+1;
    if(!selectedCards.includes(n))selectedCards.push(n);
  }
  const resultDiv=document.getElementById('result');
  resultDiv.innerHTML='';
  selectedCards.forEach(c=>{
    const fc=formatCardNumber(c);
    const box=document.createElement('div');
    box.className='card-container';
    box.innerHTML=`
      <img src="https://github.com/HourLight/11/raw/main/LINE_ALBUM_2025.3.23_250323_${c}.jpg">
      <div class="card-number">編號：${fc}</div>`;
    resultDiv.appendChild(box);
  });
  document.getElementById('answer').style.display='none';       // 抽新牌先隱藏舊解析
}

function copyResult(){
  if(selectedCards.length===0){alert("請先抽牌後再複製！");return;}
  const txt=selectedCards.map(formatCardNumber).join(', ');
  navigator.clipboard.writeText(txt).then(()=>alert('抽牌編號已複製！'))
    .catch(()=>alert('複製失敗，請手動複製：'+txt));
}

/* ★★ 新增：呼叫你自己的 GPT 後端取得解牌 ★★ */
async function interpretNow(){
  if(selectedCards.length===0){
    alert("請先抽牌，再點解析！");return;
  }
  const prompt=selectedCards.map(formatCardNumber).join(', ');
  const answerBox=document.getElementById('answer');
  answerBox.textContent='思考中…';
  answerBox.style.display='block';
  try{
    const res=await fetch('https://ai-x2if.onrender.com/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({prompt})
    });
    const data=await res.json();
    answerBox.textContent=data.text||data.error||'解析失敗，請稍後再試！';
  }catch(e){
    answerBox.textContent='伺服器打瞌睡，請稍後再試！';
    console.error(e);
  }
}
document.getElementById('interpretBtn').addEventListener('click',interpretNow);
</script>
</body>
</html>
